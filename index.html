<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>年間休日数 競争力比較 - 熊本市</title>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; }
        h1 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .controls { margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 5px; }
        .controls label { margin-right: 20px; font-weight: bold; }
        .controls select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        #vis { margin-top: 30px; }
    </style>
</head>
<body>

    <h1>熊本市 各事業所の年間休日数 競争力散布図</h1>

    <div class="controls">
        <label for="district-select">エリアで絞り込む:</label>
        <select id="district-select" onchange="updateChart()"></select>

        <label for="job-select">職種で絞り込む:</label>
        <select id="job-select" onchange="updateChart()"></select>
    </div>

    <div id="vis"></div>

    <script>
        // グラフ定義をJavaScriptオブジェクトとしてインライン化
        const vegaLiteSpecTemplate = {
            "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
            "title": "熊本市 各事業所の年間休日数散布図",
            "data": {
                "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vS5QjvstFqTzdOPORH62h7K_KCvwChYar9pJfWOfkWZ2HCoLrtLcZkzuahoosYpmafsEIBZM5az_7He/pub?gid=787523519&single=true&output=csv",
                "format": {
                    "type": "csv" 
                }
            },
            "transform": [
                // ★★★ データのクリーンアップと数値化を強化 ★★★
                {
                    "calculate": "toNumber(replace(replace(datum['年間休日数'], /\\s|日|,|〜|～/g, ''), /\\uff5e/g, ''))", 
                    "as": "年間休日数_数値"
                },
                
                // 1. データクリーニング（NULLや無効データを除外）
                {"filter": "datum.年間休日数_数値 !== null && datum.年間休日数_数値 > 0"},

                // 2. フィルタリング（JavaScriptで動的に挿入されます）
                // 3. 集計/重複排除
                {
                    "aggregate": [
                        {"op": "median", "field": "年間休日数_数値", "as": "年間休日数（中央値）"}
                    ],
                    "groupby": ["事業所名", "区", "職種分類", "業種分類"]
                },
                // 4. ランキングと中央値の再計算
                {
                    "window": [{"op": "rank", "as": "順位"}],
                    "sort": [{"field": "年間休日数（中央値）", "order": "ascending"}]
                },
                {
                    "aggregate": [{"op": "median", "field": "年間休日数（中央値）", "as": "中央値_全体"}]
                }
            ],
            "layer": [
                // 中央値の横線
                {
                    "mark": {"type": "rule", "color": "red", "strokeDash": [5, 5]},
                    "encoding": {
                        "y": {"field": "中央値_全体", "type": "quantitative", "scale": {"domain": [90, 135]}}, 
                        "tooltip": [
                            {"field": "中央値_全体", "format": ".1f", "title": "中央値"}
                        ]
                    }
                },
                // 散布図のプロット
                {
                    "mark": {"type": "circle", "size": 60},
                    "encoding": {
                        "x": {"field": "順位", "title": "求人事業所 順位 (年間休日数中央値 昇順)"},
                        "y": {"field": "年間休日数（中央値）", "title": "年間休日数（中央値） (日)", "scale": {"domain": [90, 135]}}, 
                        "color": {"field": "職種分類", "type": "nominal", "title": "職種分類", "sort": ["正看護師", "准看護師", "その他看護職"]},
                        "tooltip": [
                            "事業所名",
                            "区",
                            "職種分類",
                            "業種分類",
                            {"field": "年間休日数（中央値）", "format": ".0f", "title": "休日数中央値"}
                        ]
                    }
                }
            ],
            "config": {
                "title": {"fontSize": 16},
                "legend": {"titleFontSize": 12, "labelFontSize": 11}
            }
        };


        const jobOrder = ["正看護師", "准看護師", "その他看護職"];
        const defaultDistricts = ["中央区", "東区", "西区", "南区", "北区", "その他"];


        function initializeChart() {
            setupFilterOptions();
            updateChart(); 
        }

        function setupFilterOptions() {
            const districtSelect = document.getElementById('district-select');
            const jobSelect = document.getElementById('job-select');

            if (!districtSelect || !jobSelect) return;

            districtSelect.innerHTML = '<option value="すべて">すべて</option>';
            defaultDistricts.sort().forEach(district => {
                districtSelect.innerHTML += `<option value="${district}">${district}</option>`;
            });

            jobSelect.innerHTML = '<option value="すべて">すべて</option>';
            jobOrder.forEach(job => {
                jobSelect.innerHTML += `<option value="${job}">${job}</option>`;
            });
            jobSelect.innerHTML += '<option value="非看護職・未分類">非看護職・未分類</option>';
        }

        function updateChart() {
            let spec = JSON.parse(JSON.stringify(vegaLiteSpecTemplate));

            const selectedDistrict = document.getElementById('district-select').value;
            const selectedJob = document.getElementById('job-select').value;
            
            // フィルタリング処理に必要なデータ型を考慮し、filters配列を構築
            let filters = [];
            
            if (selectedDistrict !== "すべて") {
                filters.push({ field: "区", equal: selectedDistrict });
            }
            if (selectedJob !== "すべて") {
                filters.push({ field: "職種分類", equal: selectedJob });
            }

            // 1. フィルタリングロジックを挿入する
            // オリジナルのクリーニングトランスフォーム（[0]番目の要素）のみ残す
            let baseTransforms = [spec.transform[0]]; 

            // フィルタ処理をベーストランスフォームの直後（2番目）に挿入
            if (filters.length > 0) {
                baseTransforms.push({ filter: { and: filters } });
            }

            // フィルタ後の集計・ランキング処理を再挿入
            // 元のtransform配列の [1]、[2]、[3] 番目（集計、ランキング、中央値計算）
            baseTransforms.push(spec.transform[1], spec.transform[2], spec.transform[3]);
            spec.transform = baseTransforms; // 新しいTransform配列を適用


            // タイトルの更新
            const districtText = selectedDistrict !== "すべて" ? selectedDistrict : '全エリア';
            const jobText = selectedJob !== "すべて" ? selectedJob : '全職種';
            spec.title = { text: `${districtText} ${jobText} 年間休日数散布図` };
            
            // グラフの描画
            vegaEmbed('#vis', spec, { mode: "vega-lite", actions: false }).catch(error => {
                document.getElementById('vis').innerHTML = `<p style="color:red;">描画失敗: データ型またはヘッダーの不一致が原因です。${error.message}</p>`;
                console.error(error);
            });
        }

        window.onload = initializeChart;
    </script>

</body>
</html>
