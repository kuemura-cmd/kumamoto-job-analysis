<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>年間休日数 競争力比較 - 熊本市</title>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; }
        h1 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .controls { margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 5px; }
        .controls label { margin-right: 20px; font-weight: bold; }
        .controls select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        #vis { margin-top: 30px; }
    </style>
</head>
<body>

    <h1>熊本市 各事業所の年間休日数 競争力散布図</h1>

    <div class="controls">
        <label for="district-select">エリアで絞り込む:</label>
        <select id="district-select" onchange="updateChart()"></select>

        <label for="job-select">職種で絞り込む:</label>
        <select id="job-select" onchange="updateChart()"></select>
    </div>

    <div id="vis"></div>

    <script>
        // GitHub Pages上のJSONファイルのURLを指定
        const JSON_SPEC_URL = "annual_holidays_scatter_plot_deduplicated.json";
        
        let originalSpec = null;
        const jobOrder = ["正看護師", "准看護師", "その他看護職"];
        const defaultDistricts = ["中央区", "東区", "西区", "南区", "北区", "その他"];


        async function initializeChart() {
            try {
                // 1. JSONファイルをフェッチ
                const response = await fetch(JSON_SPEC_URL);
                if (!response.ok) {
                    throw new Error('JSONファイルを読み込めませんでした: ' + response.statusText);
                }
                // 2. オリジナルスペックとして保存
                originalSpec = await response.json();
                
                // 3. フィルタオプションを設定
                setupFilterOptions();
                
                // 4. 初期グラフの描画
                updateChart();

            } catch (error) {
                document.getElementById('vis').innerHTML = `<p style="color:red;">グラフの読み込みに失敗しました。JSONファイルが存在しないか、JSONの構文に問題があります。<br>エラー: ${error.message}</p>`;
                console.error(error);
            }
        }

        function setupFilterOptions() {
            const districtSelect = document.getElementById('district-select');
            const jobSelect = document.getElementById('job-select');

            // 選択肢の追加
            districtSelect.innerHTML = '<option value="すべて">すべて</option>';
            defaultDistricts.sort().forEach(district => {
                districtSelect.innerHTML += `<option value="${district}">${district}</option>`;
            });

            jobSelect.innerHTML = '<option value="すべて">すべて</option>';
            jobOrder.forEach(job => {
                jobSelect.innerHTML += `<option value="${job}">${job}</option>`;
            });
            jobSelect.innerHTML += '<option value="非看護職・未分類">非看護職・未分類</option>';
        }

        function updateChart() {
            if (!originalSpec) return;

            const selectedDistrict = document.getElementById('district-select').value;
            const selectedJob = document.getElementById('job-select').value;
            
            // テンプレートをコピーし、transformをリセット
            let spec = JSON.parse(JSON.stringify(originalSpec));
            
            // オリジナルのクリーニングトランスフォーム（[0]番目の要素）のみ残す
            let baseTransforms = [spec.transform[0]]; 

            let filters = [];
            
            if (selectedDistrict !== "すべて") {
                // フィルタロジックをVega-Lite形式で追加
                filters.push({ field: "区", equal: selectedDistrict });
            }
            if (selectedJob !== "すべて") {
                filters.push({ field: "職種分類", equal: selectedJob });
            }

            // フィルタ処理をベーストランスフォームの直後（2番目）に挿入
            if (filters.length > 0) {
                baseTransforms.push({ filter: { and: filters } });
            }

            // フィルタ後の集計・ランキング処理を再挿入 (元の配列の[2], [3], [4]番目)
            baseTransforms.push(spec.transform[2], spec.transform[3], spec.transform[4]);
            spec.transform = baseTransforms;


            // タイトルの更新
            const districtText = selectedDistrict !== "すべて" ? selectedDistrict : '全エリア';
            const jobText = selectedJob !== "すべて" ? selectedJob : '全職種';
            spec.title = { text: `${districtText} ${jobText} 年間休日数散布図` };
            
            // グラフの描画
            vegaEmbed('#vis', spec, { mode: "vega-lite", actions: false }).catch(error => {
                document.getElementById('vis').innerHTML = `<p style="color:red;">描画失敗: データ構造の問題、またはトランスフォーム処理のエラーです。${error.message}</p>`;
                console.error(error);
            });
        }

        window.onload = initializeChart;
    </script>

</body>
</html>
