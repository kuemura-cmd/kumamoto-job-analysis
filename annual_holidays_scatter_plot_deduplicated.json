{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": "熊本市 各事業所の年間休日数散布図",
  "data": {
    "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vS5QjvstFqTzdOPORH62h7K_KCvwChYar9pJfWOfkWZ2HCoLrtLcZkzuahoosYpmafsEIBZM5az_7He/pub?gid=787523519&single=true&output=csv",
    "format": {
      "type": "csv",
      // データ型を事前に明示的に指定
      "parse": {
        "年間休日数": "number",
        "区": "string",
        "職種分類": "string",
        "業種分類": "string",
        "事業所名": "string"
      }
    }
  },
  "params": [
    {
      "name": "district_filter",
      "bind": {
        "input": "select",
        "options": ["すべて", "中央区", "東区", "西区", "南区", "北区", "その他"],
        "name": "エリア: "
      },
      "value": "すべて"
    },
    {
      "name": "job_filter",
      "bind": {
        "input": "select",
        "options": ["すべて", "准看護師", "正看護師", "その他看護職", "非看護職・未分類"],
        "name": "職種: "
      },
      "value": "すべて"
    }
  ],
  "transform": [
    // 1. 年間休日数が0より大きいことを確認し、NULLを削除
    {"filter": "datum['年間休日数'] !== null && datum['年間休日数'] > 0"},
    
    // 2. フィルタリングを実行
    {"filter": "(datum['区'] === district_filter) || (district_filter === 'すべて')"},
    {"filter": "(datum['職種分類'] === job_filter) || (job_filter === 'すべて')"},
    
    // 3. 集計/重複排除
    {
      "aggregate": [
        {"op": "median", "field": "年間休日数", "as": "年間休日数（中央値）"}
      ],
      "groupby": ["事業所名", "区", "職種分類", "業種分類"]
    },
    
    // 4. ランキングと中央値の再計算
    {
      "aggregate": [{"op": "median", "field": "年間休日数（中央値）", "as": "中央値_全体"}],
      "as": ["中央値_全体"]
    },
    {
      "window": [{"op": "rank", "as": "順位"}],
      "sort": [{"field": "年間休日数（中央値）", "order": "ascending"}]
    }
  ],
  "layer": [
    {
      "data": {"source": "data_0"},
      "transform": [
        {"aggregate": [{"op": "median", "field": "年間休日数（中央値）", "as": "中央値_全体"}]},
        {"calculate": "'全体中央値'", "as": "tooltip_label"}
      ],
      "mark": {"type": "rule", "color": "red", "strokeDash": [5, 5]},
      "encoding": {
        "y": {"field": "中央値_全体", "type": "quantitative"},
        "tooltip": [
          {"field": "tooltip_label", "type": "nominal", "title": "中央値"},
          {"field": "中央値_全体", "format": ".1f", "title": "休日数"}
        ]
      }
    },
    {
      "mark": {"type": "circle", "size": 60},
      "encoding": {
        "x": {"field": "順位", "title": "求人事業所 順位 (年間休日数中央値 昇順)"},
        "y": {"field": "年間休日数（中央値）", "title": "年間休日数（中央値） (日)"},
        "color": {"field": "職種分類", "title": "職種分類", "sort": ["正看護師", "准看護師", "その他看護職"]},
        "tooltip": [
          "事業所名",
          "区",
          "職種分類",
          "業種分類",
          {"field": "年間休日数（中央値）", "format": ".0f", "title": "休日数中央値"}
        ]
      }
    }
  ],
  "config": {
    "title": {"fontSize": 16},
    "legend": {"titleFontSize": 12, "labelFontSize": 11}
  }
}
