{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": "熊本市 各事業所の年間休日数散布図",
  "data": {
    "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vS5QjvstFqTzdOPORH62h7K_KCvwChYar9pJfWOfkWZ2HCoLrtLcZkzuahoosYpmafsEIBZM5az_7He/pub?gid=787523519&single=true&output=csv",
    "format": {
      "type": "csv"
    }
  },
  // ★ JSONからparamsを完全に削除 ★
  "transform": [
    // 1. データクリーニング（NULLや無効データを除外）
    {"filter": "datum['年間休日数'] !== null && datum['年間休日数'] > 0"},
    // ★ フィルタはJavaScriptで動的に挿入されます
    
    // 2. 集計/重複排除
    {
      "aggregate": [
        {"op": "median", "field": "年間休日数", "as": "年間休日数（中央値）"}
      ],
      "groupby": ["事業所名", "区", "職種分類", "業種分類"]
    },
    // 3. ランキングと中央値の再計算
    {
      "window": [{"op": "rank", "as": "順位"}],
      "sort": [{"field": "年間休日数（中央値）", "order": "ascending"}]
    },
    {
      "aggregate": [{"op": "median", "field": "年間休日数（中央値）", "as": "中央値_全体"}]
    }
  ],
  "layer": [
    // 中央値の横線
    {
      "mark": {"type": "rule", "color": "red", "strokeDash": [5, 5]},
      "encoding": {
        "y": {"field": "中央値_全体", "type": "quantitative"},
        "tooltip": [
          {"field": "中央値_全体", "format": ".1f", "title": "中央値"}
        ]
      }
    },
    // 散布図のプロット
    {
      "mark": {"type": "circle", "size": 60},
      "encoding": {
        "x": {"field": "順位", "title": "求人事業所 順位 (年間休日数中央値 昇順)"},
        "y": {"field": "年間休日数（中央値）", "title": "年間休日数（中央値） (日)"},
        "color": {"field": "職種分類", "type": "nominal", "title": "職種分類", "sort": ["正看護師", "准看護師", "その他看護職"]},
        "tooltip": [
          "事業所名",
          "区",
          "職種分類",
          "業種分類",
          {"field": "年間休日数（中央値）", "format": ".0f", "title": "休日数中央値"}
        ]
      }
    }
  ],
  "config": {
    "title": {"fontSize": 16},
    "legend": {"titleFontSize": 12, "labelFontSize": 11}
  }
}
